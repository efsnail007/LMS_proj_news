{% extends 'base/base.html' %}

{% load static %}

{% block title %} Новостная лента {% endblock %}

{% block content %}
    <!-- можно потом попробовать засунуть в меню -->
    <div class="d-flex flex-wrap justify-content-around p-2 w-100 sticky-top z-3 bg-light mb-2">
        {% if request.user.is_authenticated %}
            <a href="{% url 'item:item-add' %}" class="mt-2 text-color avatar"><svg xmlns="http://www.w3.org/2000/svg"  fill="currentColor" class="bi bi-plus-circle-fill" viewBox="0 0 20 20">
                  <path d="M16 8A8 8 0 1 1 0 8a8 8 0 0 1 16 0zM8.5 4.5a.5.5 0 0 0-1 0v3h-3a.5.5 0 0 0 0 1h3v3a.5.5 0 0 0 1 0v-3h3a.5.5 0 0 0 0-1h-3v-3z"/>
                </svg></a>
        {% endif %}
        <div class="dropdown my-2">
            <!-- разобраться со стилями нажатия -->
            <button class="btn dropdown-toggle btn-filter-on" type="button" id="dropdownMenu" data-bs-toggle="dropdown" aria-expanded="false" data-bs-auto-close="outside">Фильтры</button>
            <div class="dropdown-menu" aria-labelledby="dropdownMenu">
                {% if request.user.is_authenticated %}
                <button class="dropdown-item btn text-color btn-filter" id="for-you" type="button">Для Вас</button>
                {% endif %}
                {% for tag in tags %}
                <button class="dropdown-item btn tag-button text-color btn-filter" type="button">{{ tag }}</button>
                {% endfor %}
                {% if request.user.is_authenticated %}
                <button class="dropdown-item btn tag-button text-color btn-filter" type="button">Подписки</button>
                {% endif %}
            </div>
        </div>
        <button class="btn btn-danger my-2" type="button" id="set-null">Сбросить фильтр</button>
    </div>
    <hr>
    <div id="feed">
            <!-- добавить ещё ссылку на страницу новости-->
        {% for item, profile, addition in items %}
            <div class="card border-dark mx-auto col-11 col-sm-9 col-md-10 col-lg-5 col-lg-6 overflow-hidden">
                <div class="card-header">
                    <ul class="nav nav-pills card-header-pills justify-content-between align-items-center">
                        <li class="nav-item mb-2 w-100">
                            <a class="nav-link button-bg text-decoration-none text-center text-color" href="#">На страницу новости</a> <!-- ссылка на новость -->
                        </li>
                        <li class="nav-item">
                            <a href="{% url 'user_page:user-page' item.author.username %}" class="text-decoration-none text-dark">
                            {% if profile.photo %}
                                <img class="avatar rounded-circle border border-dark" src="{{ profile.photo.url }}">
                            {% endif %}
                                <span>{{ item.author.username }}</span>
                            </a>
                        </li>
                    </ul>
                </div>
                <div class="card-body">
                    <!--<div class="mt-3 overflow-hidden">-->
                        <div class="mt-3 overflow-hidden container-fluid">
                                <div id="carouselExample{{forloop.counter0}}" class="carousel slide" data-bs-interval="false">
                                        <div class="carousel-inner">
                                            {% for file, type in addition.items %}
                                                <div class="carousel-item {% if forloop.first %}active{% endif %}">
                                                {% if type == "image" %}
                                                    <img src="{{ file }}" class="photo-border border border-dark d-block w-100">
                                                {% else %}
                                                    <video src="{{ file }}" class="video-border border border-dark d-block w-100" controls loop autoplay muted></video>
                                                {% endif %}
                                                </div>
                                            {% endfor %}
                                        </div>
                                    {% if addition|length > 1 %}
                                        <div class="mx-2 mt-1 carousel-controls d-flex justify-content-evenly">
                                            <button class="btn btn-sm btn-secondary" type="button" data-bs-target="#carouselExample{{forloop.counter0}}" data-bs-slide="prev">
                                                  <span class="carousel-control-prev-icon" aria-hidden="true"></span>
                                                  <span class="visually-hidden">Предыдущий</span>
                                                </button>
                                            <div class="carousel-indicators d-flex flex-wrap">
                                            {% for file, type in addition.items %}
                                                <button type="button" data-bs-target="#carouselExample{{forloop.parentloop.counter0}}" data-bs-slide-to="{{ forloop.counter0 }}" class="{% if forloop.first %}active{% endif %} not-active" aria-current="true"></button>
                                            {% endfor %}
                                            </div>
                                                <button class="btn btn-sm btn-secondary" type="button" data-bs-target="#carouselExample{{forloop.counter0}}" data-bs-slide="next">
                                                  <span class="carousel-control-next-icon" aria-hidden="true"></span>
                                                  <span class="visually-hidden">Следующий</span>
                                                </button>
                                        </div>
                                    {% endif %}
                                </div>
                        </div>
                    <!--</div>-->
                    <div class="card-text-items mt-2 card-text-height overflow-hidden container-fluid">
                        <p class="card-text">{{ item.text }}</p>
                    </div>
                    <div class="hidden-elem card-text-read container-fluid">
                        <a class="link-secondary">Читать далее...</a>
                    </div>
                </div>
                <ul class="d-flex flex-wrap list-group list-group-horizontal justify-content-center p-2">
                    {% for tag in item.tags.all %}
                        <li class="list-group-item tag-list-item">{{ tag }}</li>
                    {% endfor %}
                </ul>
                <div class="card-footer text-muted">
                    {{ item.created_at }}
                </div>
            </div>
            <hr>
        {% endfor %}
    </div>
    <div id="image-block-id" class="container-fluid hidden-elem mx-auto d-flex align-items-center align-self-center">
        <img src="" id="image-block-photo-id" class="hidden-elem img-fluid mx-auto">
    </div>
    <script type="text/javascript" src="{% static 'js/js_for_image.js' %}"></script>
    <script type="text/javascript">
        var image_block = document.getElementById('image-block-id');
        var image_block_photo = document.getElementById('image-block-photo-id');
        function image_block_func(image) {
            image_block.style.top = window.pageYOffset + "px";
            image_block.classList.add("image-block");
            image_block.classList.remove("hidden-elem");
            image_block_photo.classList.remove("hidden-elem");
            image_block_photo.src = image.src;
            document.body.style.overflow = "hidden";
        }

        let all_card_items = document.querySelectorAll('.card-text-items');
        let all_card_text_read = document.querySelectorAll('.card-text-read');
        for (let i = 0; i < all_card_items.length; i++) {
            if (all_card_items[i].scrollHeight > all_card_items[i].clientHeight) {
                all_card_text_read[i].classList.toggle('hidden-elem');
                all_card_text_read[i].querySelector('a').addEventListener("click", function() {
                    all_card_items[i].classList.toggle('card-text-height');
                    if (all_card_text_read[i].querySelector('a').textContent == "Читать далее...") {
                        all_card_text_read[i].querySelector('a').textContent = "Свернуть";
                    } else {
                        all_card_text_read[i].querySelector('a').textContent = "Читать далее...";
                    }
                });
            }
        }

        $(document).ready(function() {
            var feed = document.getElementById("feed");

            function cardHeader(data) {
               let card_header = document.createElement('div');
               card_header.classList.add('card-header');
               let ul = document.createElement('ul');
               ul.classList.add("nav", "nav-pills", "card-header-pills", "justify-content-between", "align-items-center");
               let firstLi = document.createElement('li');
               firstLi.classList.add("nav-item", "mb-2", "w-100");
               let aPage = document.createElement('a');
               aPage.classList.add("nav-link", "button-bg", "text-decoration-none", "text-center", "text-color");
               aPage.href = "#"; // ссылка на страницу новости
               aPage.textContent = "На страницу новости";
               firstLi.appendChild(aPage);
               let secondLi = document.createElement('li');
               secondLi.classList.add('nav-item');
               let aUsername = document.createElement('a');
               aUsername.href = '/user_page/' + data['item']['username'] + '/';
               aUsername.classList.add("text-decoration-none", "text-dark");
               if (data["profile"]) {
                    let image = document.createElement('img');
                    image.classList.add("avatar", "rounded-circle", "border", "border-dark");
                    image.src = data["profile"];
                    aUsername.appendChild(image);
               }
               let span = document.createElement('span');
               span.textContent = " " + data['item']['username'];
               aUsername.appendChild(span);
               secondLi.appendChild(aUsername);
               ul.appendChild(firstLi);
               ul.appendChild(secondLi);
               card_header.appendChild(ul);
               return card_header;
            }

            function cardBody(data) {
                let card_body = document.createElement('div');
                card_body.classList.add('card-body');
                let carousel = document.createElement('div');
                carousel.classList.add("mt-3", "overflow-hidden", "container-fluid");

                let carousel_slide = document.createElement('div');
                carousel_slide.id = "carouselExample" + String(document.querySelectorAll('.card-body').length);
                carousel_slide.classList.add("carousel", "slide");
                carousel_slide.data_bs_interval = "false";
                let carousel_inner = document.createElement('div');
                carousel_inner.classList.add('carousel-inner');
                let i = 0;
                for (const [file, type] of Object.entries(data['addition'])) {
                    let carousel_item = document.createElement('div');
                    carousel_item.classList.add("carousel-item");
                    if (i == 0)
                        carousel_item.classList.add("active");
                    if (type == "image") {
                        let img_item = document.createElement('img');
                        img_item.src = file;
                        img_item.classList.add("photo-border", "border", "border-dark", "d-block", "w-100");
                        img_item.addEventListener('click', (e) => image_block_func(img_item));
                        carousel_item.appendChild(img_item);
                    } else {
                        let video_item = document.createElement('video');
                        video_item.src = file;
                        video_item.controls = true;
                        video_item.classList.add("video-border", "border", "border-dark", "d-block", "w-100");
                        carousel_item.appendChild(video_item);
                    }
                    carousel_inner.appendChild(carousel_item);
                    i++;
                }

                carousel_slide.appendChild(carousel_inner);
                carousel.appendChild(carousel_slide);
                card_body.appendChild(carousel);
                return card_body;
            }

            function cardTags() {

            }

            function cardFooter(created_at) {

            }

            function setItemsIntoHtml(all_data) {
                for (let i = 0; i < all_data.length; i++) {
                    let card = document.createElement('div');
                    card.classList.add("card", "border-dark", "mx-auto", "col-11", "col-sm-9", "col-md-10", "col-lg-5", "col-lg-6", "overflow-hidden");

                    let card_header = cardHeader(all_data[i]);
                    card.appendChild(card_header);

                    let card_body = cardBody(all_data[i]);
                    card.appendChild(card_body);

                    feed.appendChild(card);
                }



                /* for (let i = 0; i < all_data.length; i++) {
                    let created_at = document.createElement('p');
                    created_at.textContent = all_data[i]["item"]["created_at"];
                    feed.appendChild(created_at);
                    let author_p = document.createElement('p');
                    author_p.textContent = "Автор: ";
                    let user_a = document.createElement('a');
                    user_a.textContent = all_data[i]["item"]["username"]
                    user_a.href = '/user_page/' + all_data[i]['item']['username'];
                    author_p.appendChild(user_a);
                    feed.appendChild(author_p);
                    if (all_data[i]["profile"]) {
                        let image = document.createElement('img');
                        image.src = all_data[i]["profile"];
                        feed.appendChild(image);
                    }
                    let item_text = document.createElement('p');
                    item_text.textContent = all_data[i]['item']['text'];
                    feed.appendChild(item_text);
                    let div_for_files = document.createElement('div');
                    for (const [file, type] of Object.entries(all_data[i]['addition'])) {
                        if (type == "image") {
                            let img_item = document.createElement('img');
                            img_item.src = file;
                            feed.appendChild(img_item);
                        } else {
                            let video_item = document.createElement('video');
                            video_item.src = file;
                            video_item.controls = true;
                            feed.appendChild(video_item);
                        }
                    }
                    feed.appendChild(div_for_files);
                    let ul_tags = document.createElement('ul');
                    let tags = all_data[i]['item']['tags'];
                    for (let i = 0; i < tags.length; i++) {
                        let li_tag = document.createElement('li');
                        li_tag.textContent = tags[i];
                        ul_tags.appendChild(li_tag);
                    }
                    feed.appendChild(ul_tags);
                    let hr = document.createElement('hr');
                    feed.appendChild(hr);
                }*/
            }

            var page = 1;
            var filter = [];
            var is_click_null = false;
            var is_click_subscribes = false;
            let btn_filters = document.querySelectorAll('.btn-filter');
            let for_you = document.getElementById('for-you');

            {% if filter_session %}
                filter = [];
                {% for element in filter_session %}
                    filter.push("{{ element }}");
                {% endfor %}
                    {% if is_for_you %}
                        for_you.classList.toggle('btn-filter-on');
                        for_you.classList.toggle('btn-filter');
                    {% else %}
                        for (let i = 0; i < btn_filters.length; i++) {
                            {% for element in filter_session %}
                                if (btn_filters[i].textContent == "{{ element }}") {
                                    btn_filters[i].classList.toggle('btn-filter-on');
                                    btn_filters[i].classList.toggle('btn-filter');
                                }
                            {% endfor %}
                        }
                    {% endif %}
            {% endif %}

            function ajaxOfItems(is_replace) {
                $.ajax({
                    url: "{% url 'news_feed:news-feed' %}",
                    data: {'page': page, 'action': 'feed', 'filter': filter.join(' ')},
                    dataType: "json",
                    type: 'GET',
                    success: function(data) {
                        if (page == data.page) {
                            var all_data = data.all_data;
                            if (is_replace) {
                                var feed = document.getElementById("feed");
                                if (feed.childElementCount > 0) {
                                    feed.replaceChildren();
                                }
                            }
                            setItemsIntoHtml(all_data);
                            page++;
                        }
                    }
                });
            }

            document.addEventListener('scroll', function() {
                if ((($(window).scrollTop() + $(window).height()) / $(document).height()) > 0.8) {
                    ajaxOfItems(false);
                }
            });
            let tag_buttons = document.querySelectorAll('.tag-button');
            for (let i = 0; i < tag_buttons.length; i++) {
                tag_buttons[i].addEventListener("click", function() {
                    tag_buttons[i].classList.toggle('btn-filter-on');
                    tag_buttons[i].classList.toggle('btn-filter');
                    if (is_click_null) {
                        // также в стилях снять нажатие
                        filter = [];
                        is_click_null = false;
                    }
                    if (filter.indexOf(tag_buttons[i].textContent) == -1) {
                        filter.push(tag_buttons[i].textContent);
                    } else {
                        filter.splice(filter.indexOf(tag_buttons[i].textContent), 1);
                    }
                    page = 0;
                    ajaxOfItems(true);
                });
            }
            let set_null_button = document.getElementById('set-null');
            set_null_button.addEventListener("click",  function() {
                for (let i = 0; i < tag_buttons.length; i++) {
                    tag_buttons[i].classList.add('btn-filter');
                    tag_buttons[i].classList.remove('btn-filter-on');
                }
                for_you.classList.add('btn-filter');
                for_you.classList.remove('btn-filter-on');
                filter = [];
                page = 0;
                ajaxOfItems(true);
            });
            {% if request.user.is_authenticated %}
                for_you.addEventListener("click", function() {
                    for_you.classList.toggle('btn-filter');
                    for_you.classList.toggle('btn-filter-on');
                    for (let i = 0; i < tag_buttons.length; i++) {
                        tag_buttons[i].classList.add('btn-filter');
                        tag_buttons[i].classList.remove('btn-filter-on');
                    }
                    if (!is_click_null) {
                        filter = [];
                        {% for tag in tags_for_you %}
                            filter.push("{{ tag }}");
                        {% endfor %}
                        is_click_null = true;
                    } else {
                        filter = [];
                        is_click_null = false;
                    }
                    page = 0;
                    ajaxOfItems(true);
                });
            {% endif %}
        });
    </script>
{% endblock %}